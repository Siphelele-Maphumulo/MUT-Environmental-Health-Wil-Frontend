<!-- Error Alert -->
<div *ngIf="error" class="error-alert">
  <mat-icon>error_outline</mat-icon>
  {{ error }}
  <button mat-button color="primary" (click)="loadApplications()">Retry</button>
</div>

<!-- User Info -->
<div class="user-info-container">
  <div class="user-info">
    <i class="fa fa-user-circle" aria-hidden="true"></i>
    <span class="user-email" *ngIf="userEmail">Logged: {{ userEmail }}</span>
    <span class="login-alert" *ngIf="!userEmail">User email not found. Please log in again.</span>
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid">
  <div class="main-content">
    <h2>All Students Application Forms For Work Integration Learning Placements</h2>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-row">
        <!-- Status Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select [formControl]="searchStatusControl">
            <mat-option value="" class="all-statuses-option">
              <span class="status-indicator all"></span> All Statuses
            </mat-option>
            <mat-option value="Pending" class="status-pending-option">
              <span class="status-indicator pending"></span> Pending
            </mat-option>
            <mat-option value="Accepted" class="status-accepted-option">
              <span class="status-indicator accepted"></span> Accepted
            </mat-option>
            <mat-option value="Rejected" class="status-rejected-option">
              <span class="status-indicator rejected"></span> Rejected
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Application Date Filter -->
        <mat-form-field appearance="outline" style="flex: 1 1 12%; min-width: 120px">
          <mat-label>Application Month 1-31</mat-label>
          <input matInput [matDatepicker]="applicationDatePicker" [formControl]="applicationDateControl" placeholder="Select date" />
          <mat-datepicker-toggle matSuffix [for]="applicationDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #applicationDatePicker></mat-datepicker>
        </mat-form-field>

        <!-- Level Filter -->
        <mat-form-field appearance="outline" style="flex: 1 1 12%; min-width: 120px">
          <mat-label>Level of Study</mat-label>
          <mat-select [formControl]="searchLevelControl">
            <mat-option value="">All Levels</mat-option>
            <mat-option value="1">1st Year</mat-option>
            <mat-option value="2">2nd Year</mat-option>
            <mat-option value="3">3rd Year</mat-option>
            <mat-option value="4">Undergraduate</mat-option>
            <mat-option value="5">Postgraduate</mat-option>
            <mat-option value="6">Doctorate</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Email Filter -->
        <mat-form-field appearance="outline" style="flex: 1 1 12%; min-width: 120px">
          <mat-label>Email</mat-label>
          <input matInput placeholder="Filter by email" [formControl]="searchEmailControl" />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <!-- Clear Filters Button -->
        <button mat-stroked-button color="warn" (click)="clearFilters()" style="flex: 1 1 12%; min-width: 50px; max-width: 50px; white-space: nowrap;">
          <mat-icon matSuffix>refresh</mat-icon> Clear
        </button>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div *ngIf="isLoading" class="loading-spinner">
      <mat-spinner></mat-spinner>
    </div>

    <!-- Applications Table -->
    <div class="flex-grow-1 overflow-auto" *ngIf="!isLoading">
      <table mat-table [dataSource]="filteredApplications" class="mat-elevation-z8 mat-table">
        <!-- First Names -->
        <ng-container matColumnDef="first_names">
          <th mat-header-cell *matHeaderCellDef>First Names</th>
          <td mat-cell *matCellDef="let app">{{ app.first_names }}</td>
        </ng-container>

        <!-- Surname -->
        <ng-container matColumnDef="surname">
          <th mat-header-cell *matHeaderCellDef>Surname</th>
          <td mat-cell *matCellDef="let app">{{ app.surname }}</td>
        </ng-container>

        <!-- Student Number -->
        <ng-container matColumnDef="student_number">
          <th mat-header-cell *matHeaderCellDef>Student Number</th>
          <td mat-cell *matCellDef="let app">{{ app.student_number }}</td>
        </ng-container>

        <!-- Level of Study -->
        <ng-container matColumnDef="level_of_study">
          <th mat-header-cell *matHeaderCellDef>Level</th>
          <td mat-cell *matCellDef="let app">{{ getStudyLevelLabel(app.level_of_study) }}</td>
        </ng-container>

        <!-- Email -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let app">
            <a href="mailto:{{ app.email }}" class="email-link">{{ app.email }}</a>
          </td>
        </ng-container>

        <!-- Contact Cell Phone -->
        <ng-container matColumnDef="contact_cell_phone">
          <th mat-header-cell *matHeaderCellDef>Contact #</th>
          <td mat-cell *matCellDef="let app">{{ app.contact_cell_phone }}</td>
        </ng-container>

        <!-- Municipality -->
        <ng-container matColumnDef="municipality_name">
          <th mat-header-cell *matHeaderCellDef>Municipality</th>
          <td mat-cell *matCellDef="let app">{{ app.municipality_name }}</td>
        </ng-container>

        <!-- Town Situated -->
        <ng-container matColumnDef="town_situated">
          <th mat-header-cell *matHeaderCellDef>Institution Town</th>
          <td mat-cell *matCellDef="let app">{{ app.town_situated }}</td>
        </ng-container>

        <!-- Telephone Number -->
        <ng-container matColumnDef="telephone_number">
          <th mat-header-cell *matHeaderCellDef>Tel #</th>
          <td mat-cell *matCellDef="let app">{{ app.telephone_number }}</td>
        </ng-container>

<!-- Signature Image -->
<ng-container matColumnDef="signature_image">
  <th mat-header-cell *matHeaderCellDef>Signature</th>
  <td mat-cell *matCellDef="let app">
    <!-- If you want to show the signature image -->
    <img *ngIf="app.signatureUrl" 
         [src]="app.signatureUrl" 
         (error)="onImageError($event, 'signature')"
         alt="Signature" 
         class="signature-image"
         style="max-width: 100px; max-height: 50px; margin-left: 8px;">
  </td>
</ng-container>

<!-- Status -->
<ng-container matColumnDef="status">
  <th mat-header-cell *matHeaderCellDef>Status</th>
  <td mat-cell *matCellDef="let app">
    <!-- Option 1: Using ngClass (recommended) -->
    <span class="status-badge" [ngClass]="getStatusClass(app.status)">
      {{ app.status }}
    </span>
    
  </td>
</ng-container>

        <!-- Created At -->
        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let app">{{ app.created_at | date: 'M/d/yyyy' }}</td>
        </ng-container>

<!-- ID Document -->
<ng-container matColumnDef="id_document">
  <th mat-header-cell *matHeaderCellDef>ID</th>
  <td mat-cell *matCellDef="let app">
    <button mat-icon-button 
           (click)="downloadDocument(app, 'id')"
           [disabled]="!app.id_document"
           title="Download ID">
      <mat-icon>download</mat-icon>
    </button>
  </td>
</ng-container>

<!-- CV Document -->
<ng-container matColumnDef="cv_document">
  <th mat-header-cell *matHeaderCellDef>CV</th>
  <td mat-cell *matCellDef="let app">
    <button mat-icon-button 
           (click)="downloadDocument(app, 'cv')"
           [disabled]="!app.cv_document"
           title="Download CV">
      <mat-icon>download</mat-icon>
    </button>
  </td>
</ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let app">
            <button mat-icon-button (click)="viewDetails(app)" title="View Details">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>

    <!-- No Data Message -->
    <div *ngIf="!isLoading && filteredApplications.length === 0" class="no-data">
      <mat-icon>info</mat-icon>
      <p>No applications found matching your criteria.</p>
    </div>
  </div>
</div>